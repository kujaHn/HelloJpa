# JPA 시작
## Member테이블 생성  
먼저 `H2`에 `Member 테이블`을 생성하자.
|컬럼명|타입|비고|
|:---:|:---:|:---:|
|id|Bigint|PK|
|name|varchar(255)| |  
  
다음과 같은 쿼리문을 작성하면 된다.  
```
CREATE TABLE MEMBER(
    ID BIGINT NOT NULL,
    NAME VARCHAR(255),
    PRIMARY KEY(ID)
);
```

## `Member` 엔티티 생성 (객체 매핑)
JPA를 사용하려면 가장 먼저 Member `클래스`와 `테이블`을 매핑해야 한다.  
```
@Entity
public class Member {
    @Id
    private long id;

    private String name;

    public long getId() {
        return id;
    }

    public void setId(long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}
```

* `@Entity` : JPA가 관리할 객체 지정 (JPA에서 테이블에 매핑할 클래스에 붙인다.)
* 기본적으로 엔티티 이름은 `객체명`의 `camelCase` 형태를 띈다.
  * 만약 DB의 테이블 이름이 축약어를 써야된다거나 해서 엔티티명과 다르면 `@Table(name = "")` 로 매핑할 테이블 이름 변경이 가능하다. 
* `@Id` : 데이터 베이스 **기본키(Primary Key)** 매핑
  
  
  
## `persistence.xml` 설정
JPA는 `persistence.xml`을 사용해서 필요한 설정정보를 관리한다.  
이 파일이 `META-INF/persistence.xml` 클래스 패스 경로에 있으면 별도의 설정 없이 JPA가 인식할 수 있다.
* `resources` 디렉토리에 추가를 하고 밑의 코드를 붙여넣자.
```
<?xml version="1.0" encoding="UTF-8"?>
<persistence version="2.2"
             xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd">
    <persistence-unit name="hello">
        <properties>
            <!-- 필수 속성 -->
            <property name="javax.persistence.jdbc.driver" value="org.h2.Driver"/>
            <property name="javax.persistence.jdbc.user" value="sa"/>
            <property name="javax.persistence.jdbc.password" value=""/>
            <property name="javax.persistence.jdbc.url" value="jdbc:h2:tcp://localhost/~/test"/>
            <property name="hibernate.dialect" value="org.hibernate.dialect.H2Dialect"/>

            <!-- 옵션 -->
            <property name="hibernate.show_sql" value="true"/>
            <property name="hibernate.format_sql" value="true"/>
            <property name="hibernate.use_sql_comments" value="true"/>
            <!--<property name="hibernate.hbm2ddl.auto" value="create" />-->
        </properties>
    </persistence-unit>
</persistence>
```
하나하나씩 뜯어서 보자.  
```
<persistence version="2.2"
             xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xs
```
* 설정파일은 persistence로 시작하고 `XML 네임 스페이스`와 `버전`이 명시되어 있다.  


`<persistence-unit name="hello">`  
* Jpa 설정은 `영속성 유닛(Persistence-unit)`이 시작인데, DB당 하나의 영속성 유닛을 등록한다.
* 영속성 유닛들은 고유한 이름을 부여해야 한다( 여기선 `hello` 부여)

```
            <property name="javax.persistence.jdbc.driver" value="org.h2.Driver"/>
            <property name="javax.persistence.jdbc.user" value="sa"/>
            <property name="javax.persistence.jdbc.password" value=""/>
            <property name="javax.persistence.jdbc.url" value="jdbc:h2:tcp://localhost/~/test"/>
            <property name="hibernate.dialect" value="org.hibernate.dialect.H2Dialect"/>
```
다음은 Jpa의 `필수(표준)속성`을 입력할 차례이다.  
  * `javax.persistence.jdbc.driver` : JDBC 드라이버  
  * `javax.persistence.jdbc.user` : 접속 ID  
  * `javax.persistence.jdbc.password` : 접속 비밀번호  
  * `property name="javax.persistence.jdbc.url` : 접속 URL  
  * `hibernate.dialect` : 데이터 베이스 방언 설정
    * JPA는 특정 DBMS에 종속적이지 않은 기술이다. 따라서 손쉽게 교체가 가능한데, **문제점은 각 DBMS마다 SQL 문법과 함수가 다르다.**
    * 이렇게 SQL표준이 아닌 특정 DBMS만의 고유한 기능이나 문법들을 JPA에서는 방언이라고 한다. (표준어와 사투리(방언))
    * 이 문제를 해결하기 위해서 `Dialect`를 통해 각 DBMS에 맞는 방언을 설정할 수 있다. (H2는 `H2Dialect`로 설정할 수 있다.)  
  ![image](https://user-images.githubusercontent.com/72388950/112188784-a512bc80-8c46-11eb-8b3a-eed6fabcef53.png)

 * 추가적으로 `@Entity`를 입력했는데도 인식을 못하는 경우 `<class>클래스패스</class>`로 매핑이 가능하다.  

이번에는 `추가 옵션`을 입력할 차례이다.
```
            <property name="hibernate.show_sql" value="true"/>
            <property name="hibernate.format_sql" value="true"/>
            <property name="hibernate.use_sql_comments" value="true"/>
            <!--<property name="hibernate.hbm2ddl.auto" value="create" />-->
```
  * `hibernate.show_sql` : Run 시 SQL문을 볼 것인가 설정.
  * `hibernate.format_sql` : SQL 포맷으로 깔끔하게 보여주는 옵션
  * `<property name="hibernate.hbm2ddl.auto" value="create" />` : 스키마 자동 생성 기능. => 현재는 주석처리



## 엔티티 매니저 설정

기초적인 작업들은 이미 스프링에 이미 구현되어 있다. 하지만 작동원리를 이해하기 위해서 구현해보자.  
```
public class JpaMain {
    public static void main(String[] args) {

        EntityManagerFactory emf = Persistence.createEntityManagerFactory("hello");
        EntityManager em = emf.createEntityManager();

        EntityTransaction transaction = em.getTransaction();
        transaction.begin();
        try {
        logic(em);
        transaction.commit();
        } catch (Exception e){
            transaction.rollback();
        }
        finally {
            em.close();
        }
        emf.close();
    }
}
```
### `EntityManagerFactory`
  * JPA를 시작하려면 `META-INF/persistence.xml`의 설정정보를 가져와서 `EntityManagerFactory`을 생성 해야 한다. 
    * `createEntityManagerFactory("hello");` 메소드는 이름이 `hello`인 영속성(persistence) 유닛을 찾아서 `EntityManagerFactory`를 생성.
    * 설정정보를 통해 JPA 구동 기반 객체를 생성하는데 JPA 구현체에 따라 `커넥션 풀`도 생성하기 때문에 생성 비용이 매우 크다.  
     => **애플리케이션 전체에서 딱 한 번만 생성하고 공유해서 사용해야 한다.**
    * 마지막에 `close()`를 통해 **반드시 종료 하자.**
     
### `EntityManager`
  * `EntityManager`는 JPA의 기능 대부분을 제공. (ex : CRUD)
  * 내부에 커넥션을 **유지**하면서 DB와 통신 (가상의 DB라고 생각해도 무방하다.)
  * **DB 커넥션과 밀접한 관계가 있어서 스레드간에 공유하거나 재사용해서는 안된다!!**
  * 마지막에 `close()`를 통해 **반드시 종료 하자.**

### `Transaction`
  * **JPA를 사용하려면 항상 `트랜젝션` 안에서 데이터를 변경해야 함. => 위반 시 예외발생**
  * `EntityManager`의 `getTransaction()`을 통해 `트랜젝션 API`를 받아와야 한다.
  * `try/catch`를 사용해서 정상적으로 처리된다면 `commit()`을 예외가 발생하면 `rollback()`를 실행하게 설계하자.


## 기초 CRUD 실습
이제 `CrudLogic` 클래스를 생성해서 `CRUD` 로직을 구현해 보자.
### 회원 생성
```
    public static void create(EntityManager em) {
        //데이터 입력
         Member newMember = new Member();
         newMember.setId(1L);
         newMember.setName("nameA");

         //persist() 메소드를 통해 등록
         em.persist(newMember);
    }
```  
1. 회원 엔티티를 생성 한 후 `persist()` 메소드에 저장할 엔티티를 넘겨줌.  
2. JPA는 매핑 정보를 통해서 SQL을 만들어 DB에 전달.  
  ![image](https://user-images.githubusercontent.com/72388950/112178075-d5edf400-8c3c-11eb-8568-8561b298b568.png)


### 회원 조회
```
    public static void read(EntityManager em) {
         // 방법 1
         Member findMember = em.find(Member.class, 1L);
         System.out.println("findMember.getId() = " + findMember.getId());
         System.out.println("findMember.getName() = " + findMember.getName());

         // 방법 2
          List<Member> result = em.createQuery("select m from Member as m", Member.class)
          
          추가설정 : 페이지 설정
          .setFirstResult(5)
          .setMaxResults(8)
          
          결과 리스트
          .getResultList();
         
          출력
          for (Member member : result) {
              System.out.println("member.name = " + member.getName());
          } 
    }
```
방법 1 : `find()` 메소드 사용  
  * 파라미터 : `find(찾고싶은 테이블이 매핑된 엔티티클래스 타입, 엔티티 식별자 값(@Id로 매핑된 값))`  
  
방법 2 : `createQuery()`를 통한 `JPQL` 사용  
  * (조건을 걸고) 다수의 데이터를 검색하고 싶을때 사용 (ex. 18세 이상인 회원들을 조회)  
  * JPQL이란? : 객체지향 쿼리 언어 => 데이터베이스 방언을 통해 수정할 필요 없이 각 DB의 쿼리로 변형 가능.
   
### 회원 수정(업데이트)
```
    public static void update(EntityManager em) {
        Member updateMember = em.find(Member.class, 1L);
        updateMember.setName("UpdatedNameA");
    }
```
1. 수정하고 싶은 데이터를 찾아서 setter을 통해 수정
2. commit 시점에 JPA가 수정 전 데이터와 비교를 함.  
   ![image](https://user-images.githubusercontent.com/72388950/112178872-79d79f80-8c3d-11eb-92de-d7a4ab78a078.png)

3. 전과 후의 데이터가 다르면 자동으로 업데이트 쿼리를 생성해서 업데이트 실시.  
  ![image](https://user-images.githubusercontent.com/72388950/112178930-85c36180-8c3d-11eb-9ef5-b1c3bfd1533b.png)

* **결론 : JPA는 업데이트를 할때 따로 데이터를 저장할 필요가 없다.**
  
### 회원 삭제
```
    public static void delete(EntityManager em) {
        Member deleteMember = em.find(Member.class, 1L);
        em.remove(deleteMember);
    }
```
1. 삭제하고 싶은 데이터를 찾은 후
2. `remove()` 메소드를 통해 삭제하자.  
  ![image](https://user-images.githubusercontent.com/72388950/112179074-b3a8a600-8c3d-11eb-8c34-57efceb72a3c.png)
