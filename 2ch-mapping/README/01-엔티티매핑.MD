# 엔티티 매핑
JPA에서 가장 중요한 일은 `엔티티`와 `테이블`을 정확히 매핑하는 것이다.  
이번 장에서는 다음과 같은 매핑을 살펴볼 것이다.  
* 객체와 테이블 매핑 : `@Entity`, `@Table`
* 필드와 컬럼 매핑 : `@Column`
* 기본 키 매핑 : `@Id`
* 연관관계 매핑 : `@ManyToOne`, `@JoinColumn`

## 객체와 테이블 매핑 
  ### @Entity
  * @Entity가 붙은 클래스는 JPA가 관리하고 `엔티티`라고 한다.
  * 속성
      * name : JPA에서 사용할 엔티티 이름 지정. (기본값 : 클래스 명)
    
      
  * 주의사항
      * `기본 생성자`를 필수로 요함.
      * `final`, `enum`, `interface`, `inner` 클래스에서는 사용X
      * 저장할 필드에 `final` 사용 X
    
  ### @Table
  * 엔티티와 매핑할 **`테이블`을 지정.**
  * 속성
      * name : 매핑할 테이블 이름 지정. (기본값 : 엔티티명)
      * catalog : `catalog` 기능이 있는 DB에서 catalog 매핑
      * schema : `schema` 기능이 있는 DB에서 schema 매핑
  
## 필드와 컬럼 매핑
* 종류
  * @Column : 컬럼 매핑
  * @Temporal : 날짜 타입 매핑
    * `자바8`로 넘어오면서 `LocalDate`, `LocalDateTime`이 지원! 생략이 가능해짐.
  * @Enumerated : enum 타입 매핑
    * `EnumType.ORDINAL` : enum `순서` 를 DB에 저장 => 사용X
    * `EnumType.STRING` : enum `이름`을 DB에 저장 => 대부분 이것 사용.
  * @Lob : BLOB, CLOB 매핑
    * BLOB : `byte[]`, `java.sql.BLOB`
    * CLOB : `String`, `char[]`, `java.sql.CLOB`
  * @Transient : 매핑 X ==> DB에 저장 X (메모리상에서 임시로 값을 보관하고 싶을 때 사용)

## 기본 키 매핑
* 직접할당 : `@Id`를 통해 직접 할당.
* 자동 생성 : `대리 키`사용.

  ### IDENTITY
  * 기본 키 생성을 DB에 위임. **(= DB가 기본 키를 자동으로 생성)** (EX : MySQL의 `AUTO_INCREMENT`)
  * 보통 JPA는 보통 `트랜잭션 커밋` 시점에 `INSERT 쿼리`를 실행한다. 이렇게 되면 `기본키`를 `DB`에서 생성하기 때문에 JPA는 중간 로직에서 `기본키`를 알 수 없다.
  * 작동원리
    1. `PERSIST` 시점에서 즉시 `INSERT 쿼리`를 실행 해 엔티티를 DB에 저장
    2. DB에서 식별자를 조회 후 엔티티의 식별자에 할당.
  * MySQL, PostgreSQL, SQL Server, DB2에서 사용

  ### SEQUENCE
  * 시퀀스는 유일한 값을 순서대로 생성하는 특별한 데이터베이스 오브젝트
  * 작동원리 
    1. `PERSIST` 호출 시점에서 먼저 `SEQUENCE`를 사용해서 식별자를 조회함. 
    2. 조회한 식별자를 엔티티에 할당한 후 엔티티를 `영속성 컨텍스트`에 저장한다.
    3. 트랜잭션을 커밋해서 `플러시`가 일어나면 엔티티를 DB에 저장한다.


  ![사용 방법](hellojpa2/image/SequenceGenerator.PNG)
  * 오라클, PostgreSQL, DB2, H2 데이터베이스에서 사용


  ### TABLE
  * 키 생성 전용 테이블을 하나 만들어서 DB 시퀸스를 흉내내는 전략
  * 테이블을 사용하므로 모든 DB에 적용이 가능하나 성능이 좋지 않다.
## 데이터베이스 스키마 자동 생성(DDL)
* `매핑정보`와 `데이터베이스 방언`을 사용해서 애플리케이션 실행 시점에 자동으로 `DB 스키마`를 생성.
* 테이블을 먼저 생성하던 것을 객체만 생성하고 매핑만 하면 되기 떄문에 테이블 중심에서 `객체 중심`으로 변화.
* `persistence.xml` 추가옵션에서 `<property name="hibernate.hbm2ddl.auto" value="속성" />` 입력
* **DDL 생성 기능은 DDL을 자동 생성할 때만 사용되고 일반적인 JPA 실행 로직에는 영향을 주지 않음.**
* 속성
  * create : 기존테이블 삭제 후 다시 생성 (DROP + CREATE)
  * create-drop : `create`와 같으나 종료시점에서 테이블 DROP (DROP + CREATE + DROP)
  * update : 변경분만 반영함. (단 추가 변경만 수정이 되고, 누락된 것은 반영 안됨.)
  * validate : `엔티티`와 `테이블`이 정상 매핑되어 있는지 확인
  * none : `비활성화` 기능.


* 주의점
  * 운영장비에서 절대 사용하면 안됨.
  * 개발 단계에서만 사용하는 것을 권장
    * 개발 초기에만 `create` 사용
    * 나머지는 `validate` 위주로
  * 제약조건 추가
    * `@Column(nullable = false, length = 10`
    * `nullable`로 `not null`을 `length`로 길이를 제한.
    * ![제약조건 결과](hellojpa2/image/entitymapping1.PNG)
  